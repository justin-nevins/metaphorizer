{% extends "base.html" %}
{% block title %}Review Metaphors{% endblock %}
{% block content %}
<div class="flex items-center justify-between mb-6">
    <div>
        <h1 class="text-2xl font-bold">Review Metaphors</h1>
        <p class="text-sm text-gray-500 mt-1">
            {{ stats.processed_chapters }}/{{ stats.total_chapters }} chapters processed
            Â· {{ stats.total_metaphors }} metaphors found
        </p>
    </div>
    <div class="flex gap-2">
        <button
            id="extract-btn"
            onclick="startExtraction()"
            class="px-4 py-2 bg-gray-900 text-white rounded hover:bg-gray-700 transition text-sm"
        >
            Extract All Chapters
        </button>
    </div>
</div>

<div id="extraction-progress" class="hidden mb-6 p-4 bg-blue-50 rounded-lg text-sm">
    <p id="extraction-status">Extracting...</p>
</div>

<!-- Filters -->
<div class="flex gap-4 mb-4 text-sm">
    <select id="filter-chapter" onchange="filterMetaphors()" class="border rounded px-3 py-1.5">
        <option value="">All Chapters</option>
        {% for ch in chapters %}
        <option value="{{ ch.id }}">Chapter {{ ch.number }}</option>
        {% endfor %}
    </select>
    <select id="filter-topic" onchange="filterMetaphors()" class="border rounded px-3 py-1.5">
        <option value="">All Topics</option>
        {% for t in topics %}
        <option value="{{ t }}">{{ t }}</option>
        {% endfor %}
    </select>
    <label class="flex items-center gap-1.5">
        <input type="checkbox" id="filter-selected" onchange="filterMetaphors()">
        Selected only
    </label>
</div>

<!-- Metaphor Table -->
<div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
    <table class="w-full text-sm" id="metaphor-table">
        <thead class="bg-gray-50 border-b">
            <tr>
                <th class="w-10 px-4 py-3"></th>
                <th class="text-left px-4 py-3 font-medium">Ch</th>
                <th class="text-left px-4 py-3 font-medium w-1/3">Quote</th>
                <th class="text-left px-4 py-3 font-medium">Explanation</th>
                <th class="text-left px-4 py-3 font-medium">Topic</th>
                <th class="text-center px-4 py-3 font-medium w-16">Conf</th>
            </tr>
        </thead>
        <tbody>
            {% for m in metaphors %}
            <tr class="border-b last:border-0 metaphor-row"
                data-chapter="{{ m.chapter_id }}"
                data-topic="{{ m.suggested_topic }}"
                data-selected="{{ m.selected|lower }}">
                <td class="px-4 py-3">
                    <input type="checkbox" {{ "checked" if m.selected }}
                        hx-post="/api/metaphors/{{ m.id }}/toggle"
                        hx-swap="none">
                </td>
                <td class="px-4 py-3 text-gray-500">{{ m.chapter_id }}</td>
                <td class="px-4 py-3 italic text-gray-700">"{{ m.exact_quote[:120] }}{% if m.exact_quote|length > 120 %}...{% endif %}"</td>
                <td class="px-4 py-3 text-gray-600">{{ m.explanation[:100] }}{% if m.explanation|length > 100 %}...{% endif %}</td>
                <td class="px-4 py-3">
                    <span class="inline-block px-2 py-0.5 bg-gray-100 rounded text-xs">{{ m.suggested_topic }}</span>
                </td>
                <td class="px-4 py-3 text-center">
                    <span class="{% if m.confidence >= 0.8 %}text-green-600{% elif m.confidence >= 0.5 %}text-yellow-600{% else %}text-red-500{% endif %}">
                        {{ "%.0f"|format(m.confidence * 100) }}%
                    </span>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
function startExtraction() {
    const progress = document.getElementById('extraction-progress');
    const status = document.getElementById('extraction-status');
    progress.classList.remove('hidden');

    const source = new EventSource('/api/extract/stream');
    source.onmessage = function(event) {
        const data = JSON.parse(event.data);
        if (data.status === 'done') {
            source.close();
            status.textContent = 'Extraction complete! Reloading...';
            setTimeout(() => location.reload(), 1000);
        } else {
            status.textContent = `Chapter ${data.chapter}: ${data.status}`;
        }
    };
    source.onerror = function() {
        source.close();
        status.textContent = 'Connection lost. Refresh to see results.';
    };
}

function filterMetaphors() {
    const chapter = document.getElementById('filter-chapter').value;
    const topic = document.getElementById('filter-topic').value;
    const selectedOnly = document.getElementById('filter-selected').checked;

    document.querySelectorAll('.metaphor-row').forEach(row => {
        let show = true;
        if (chapter && row.dataset.chapter !== chapter) show = false;
        if (topic && row.dataset.topic !== topic) show = false;
        if (selectedOnly && row.dataset.selected !== 'true') show = false;
        row.style.display = show ? '' : 'none';
    });
}
</script>
{% endblock %}
